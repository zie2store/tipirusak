<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Document Viewer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div id="document-container"></div>

  <script>
    function slugify(title) {
      return title.trim()
                  .toLowerCase()
                  .replace(/\s+/g, '-')
                  .replace(/[^\w\-]/g, '');
    }

    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    const documentId = getQueryParam('document');
    const titleSlug = window.location.hash.slice(1);
    const container = document.getElementById('document-container');

    if (!documentId || !titleSlug) {
      container.innerHTML = `<p>Error: Missing document ID or title in URL.</p>`;
      throw new Error('Missing document ID or title');
    }

    fetch('https://raw.githubusercontent.com/zie2store/tipirusak/main/public/scrbd.csv')
      .then(response => response.text())
      .then(csvText => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            const data = results.data;

            const doc = data.find(d =>
              d.ID.trim() === documentId.trim() &&
              slugify(d.Title) === titleSlug
            );

            if (!doc) {
              container.innerHTML = `<p>Document not found for ID: ${documentId} and title: ${titleSlug}</p>`;
              return;
            }

            const iframe = `
              <iframe class="scribd_iframe_embed"
                title="${doc.Title}"
                src="https://www.scribd.com/embeds/${doc.ID}/content?start_page=1&view_mode=scroll&access_key=key-NCzuA9v6DY7zHHNCjjID"
                tabindex="0"
                data-auto-height="true"
                data-aspect-ratio="0.6536"
                scrolling="no"
                width="100%"
                height="600"
                frameborder="0">
              </iframe>
            `;

            container.innerHTML = `
              <h1>${doc.Title}</h1>
              <p>
                This document is entitled <strong>${doc.Title}</strong> and is uploaded by Scribd Download Team.
                It contains <strong>${doc.Pages}</strong> pages. This document with ID <strong>${doc.ID}</strong>
                has been downloaded <strong>${doc.Views}</strong> times. The information we can get from
                <strong>${doc.Title}</strong> includes <em>${doc.Summary}</em>.
              </p>
              ${iframe}
            `;
          }
        });
      })
      .catch(err => {
        console.error('Failed to load CSV:', err);
        container.innerHTML = `<p>Error loading document data.</p>`;
      });
  </script>
</body>
</html>
