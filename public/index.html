<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Loading document...</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    .download-button {
      display: inline-block;
      margin-bottom: 20px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      font-weight: bold;
    }
    .download-button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div id="document-container"></div>

  <script>
    function slugify(title) {
      return title.trim()
                  .toLowerCase()
                  .replace(/\s+/g, '-')
                  .replace(/[^\w\-]/g, '');
    }

    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    const documentId = getQueryParam('document');
    const titleSlug = window.location.hash.slice(1);
    const container = document.getElementById('document-container');

    if (!documentId || !titleSlug) {
      container.innerHTML = `<p>Error: Missing document ID or title in URL.</p>`;
      throw new Error('Missing document ID or title');
    }

    fetch('https://raw.githubusercontent.com/zie2store/tipirusak/main/public/scrbd.csv')
      .then(response => response.text())
      .then(csvText => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            const data = results.data;

            const doc = data.find(d =>
              d.ID.trim() === documentId.trim() &&
              slugify(d.Title) === titleSlug
            );

            if (!doc) {
              container.innerHTML = `<p>Document not found for ID: ${documentId} and title: ${titleSlug}</p>`;
              return;
            }

            document.title = doc.Title;

            const downloadUrl = `https://ilide.info/docgeneratev2?fileurl=https://scribd.vdownloaders.com/pdownload/${doc.ID}/`;

            const html = `
              <h1>${doc.Title}</h1>
              <p>
                This document is entitled <strong>${doc.Title}</strong> and is uploaded by Scribd Download Team.
                It contains <strong>${doc.Pages}</strong> pages. This document with ID <strong>${doc.ID}</strong>
                has been downloaded <strong>${doc.Views}</strong> times. The information we can get from
                <strong>${doc.Title}</strong> includes <em>${doc.Summary}</em>.
              </p>

              <a class="download-button" href="${downloadUrl}" target="_blank">â¬‡ Download Document</a>

              <iframe class="scribd_iframe_embed"
                title="${doc.Title}"
                src="https://www.scribd.com/embeds/${doc.ID}/content?start_page=1&view_mode=scroll&access_key=key-NCzuA9v6DY7zHHNCjjID"
                tabindex="0"
                data-auto-height="true"
                data-aspect-ratio="0.6536"
                scrolling="no"
                width="100%"
                height="600"
                frameborder="0">
              </iframe>
            `;

            container.innerHTML = html;
          }
        });
      })
      .catch(err => {
        console.error('Failed to load CSV:', err);
        container.innerHTML = `<p>Error loading document data.</p>`;
      });
  </script>
</body>
</html>
