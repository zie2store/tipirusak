<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title id="dynamic-title">Loading...</title>
  <meta name="description" content="Search Scribd documents by title or summary.">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
 <link rel="stylesheet" href="/style.css" />
 <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  
  <!-- Header -->
  <header>
    <div class="container">
      <div class="logo">[scrbd]</div>
      <form id="searchForm" class="search-form">
        <input
          type="text"
          name="query"
          id="searchInput"
          class="search-input"
          placeholder="type document you want to find..." />
        <button type="submit">search</button>
      </form>
    </div>
  </header>
  <main>
  <h1 id="header">Search Results</h1>
  <div id="results">Searching...</div>
  </main>
   <!-- Footer -->
  <footer>
    <nav>
      <a href="#">ABOUT</a>
      <a href="#">CONTACT US</a>
      <a href="#">PRIVACY POLICY</a>
    </nav>
    <div class="footerdesc">
      Lorem ipsum dolor dolor kabeh ingkah kerso monggo mblebet mawon nggih. Yo piye neh lah bro. Ngene iki keadaanne.<br>
      &copy;2025 - Scrbd Document Finder
    </div>
  </footer>

  <script>
    function slugify(title) {
      return title.trim()
                  .toLowerCase()
                  .replace(/\s+/g, '-')
                  .replace(/[^\w\-]/g, '');
    }

    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlight(text, words) {
      let escapedWords = words.map(w => escapeRegExp(w));
      const pattern = new RegExp(`(${escapedWords.join('|')})`, 'gi');
      return text.replace(pattern, '<mark>$1</mark>');
    }

    const baseUrl = window.location.origin;
    const queryParam = getQueryParam('query');
    if (queryParam) {
      document.title = `All documents related to ${queryParam.replace(/-/g, ' ')}`;
        }
    const queryWords = queryParam ? queryParam.toLowerCase().split('-').filter(Boolean) : [];

    const headerEl = document.getElementById('header');
    const container = document.getElementById('results');

    if (!queryParam || queryWords.length === 0) {
      headerEl.textContent = "Please enter a search query.";
      container.innerHTML = "";
      throw new Error('No query provided');
    }

    fetch('https://raw.githubusercontent.com/zie2store/tipirusak/main/public/scrbd.csv')
      .then(response => response.text())
      .then(csvText => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            const data = results.data;

            const matches = data.filter(d => {
              const title = d.Title.toLowerCase();
              const summary = d.Summary.toLowerCase();
              return queryWords.some(q =>
                title.includes(q) || summary.includes(q)
              );
            });

            if (matches.length > 0) {
              headerEl.textContent = `${matches.length} document${matches.length !== 1 ? 's' : ''} found for '${queryParam.replace(/-/g, ' ')}'.`;
    
              const output = matches.map(d => {
                const slug = slugify(d.Title);
                const url = `${baseUrl}/viewer.html?document=${d.ID}#${slug}`;
                const highlightedTitle = highlight(d.Title, queryWords);
                const highlightedSummary = highlight(d.Summary, queryWords);
                return `
                  <div class="related-post">
                  <div class="related-post-title">
                    <a href="${url}">${highlightedTitle}</a></div>
                    <div class="related-post-text">${highlightedSummary}
                    <hr class="post-divider">
                    </div>
                  </div>
                `;
              }).join('');

              container.innerHTML = output;
            } else {
              headerEl.textContent = `No documents found for '${queryParam.replace(/-/g, ' ')}'. But, these documents might be interesting for you.`;
              
              const shuffled = data.sort(() => 0.5 - Math.random()).slice(0, 10);

              const suggestions = shuffled.map(d => {
                const slug = slugify(d.Title);
                const url = `${baseUrl}/viewer.html?document=${d.ID}#${slug}`;
                return `
                <div class="related-post">
                <div class="related-post-title">
                  <a href="${url}">${d.Title}</a></div>
                  <div class="related-post-text">${d.Summary}
                    <hr class="post-divider">
                  </div>
               </div>
              `;
            }).join('');

            container.innerHTML = `
          
                ${suggestions}
              `;
            }
          }
        });
      })
      .catch(err => {
        console.error('Error loading search results:', err);
        container.innerHTML = '<p>Error loading search results.</p>';
      });

    document.getElementById('searchForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const input = document.getElementById('searchInput').value.trim();
      if (input) {
        const query = input.toLowerCase().replace(/\s+/g, '-');
        window.location.href = `${baseUrl}/search.html?query=${query}`;
      }
    });
  </script>
  <script src="/script.js"></script>
</body>
</html>
